<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Stock Control - ฟาร์มจูล</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007aff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ฟาร์มจูล">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/561/561184.png">

<style>
:root {
  --system-bg: #e5e5ea;
  --glass: rgba(255, 255, 255, 0.9);
  --mac-use: #34c759;   /* เขียวสำหรับใช้วัตถุดิบ */
  --mac-produce: #007aff; /* น้ำเงินสำหรับผลิตเพิ่ม */
  --mac-blue: #007aff;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "SF Pro Display", sans-serif; }
body { margin: 0; background-color: var(--system-bg); background-image: radial-gradient(circle at 50% 50%, #f2f2f7 0%, #c7c7cc 100%); height: 100vh; overflow: hidden; }

/* Animation สำหรับรหัสผิด */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-10px); }
  40%, 80% { transform: translateX(10px); }
}
.error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

/* Panels */
.app-container { display: flex; height: 100vh; padding: 25px; gap: 20px; filter: blur(20px); transition: filter 0.5s; position: relative; }
.app-container.unlocked { filter: blur(0); }
.panel { background: var(--glass); backdrop-filter: blur(40px); border: 1px solid rgba(255,255,255,0.4); border-radius: 30px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 15px 45px rgba(0,0,0,0.1); }
.left-panel { width: 45%; padding-top: 65px; }
.right-panel { width: 55%; }

/* Language & Tabs */
.lang-bar { position: absolute; top: 25px; left: 40px; z-index: 100; display: flex; gap: 6px; background: rgba(0,0,0,0.08); padding: 5px; border-radius: 14px; }
.lang-btn { padding: 8px 18px; font-size: 13px; font-weight: 700; border-radius: 10px; cursor: pointer; border: none; background: transparent; }
.lang-btn.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); color: var(--mac-blue); }

.tab-group { display: flex; background: rgba(0,0,0,0.06); margin: 15px; border-radius: 15px; padding: 3px; position: relative; }
.tab-slider { position: absolute; top: 3px; bottom: 3px; width: calc(50% - 3px); background: white; border-radius: 12px; transition: 0.35s cubic-bezier(0.2, 0, 0, 1); }
.tab { flex: 1; padding: 12px; text-align: center; font-size: 13px; font-weight: 700; cursor: pointer; position: relative; z-index: 2; color: #666; }

/* Grid */
.item-list { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; align-content: start; }
.item-card { 
    position: relative; background: #636366; border-radius: 20px; height: 100px; 
    overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 4px solid transparent;
}
.item-card.active-use { border-color: var(--mac-use); }
.item-card.active-produce { border-color: var(--mac-produce); }
.overlay-text { position: relative; z-index: 2; color: white; text-align: center; font-weight: 800; text-shadow: 0 2px 8px rgba(0,0,0,0.8); display: flex; flex-direction: column; }

/* Modals */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(20px); }
.modal-box { background: white; width: 520px; border-radius: 35px; padding: 30px; max-height: 85vh; overflow-y: auto; }
input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; margin-top: 8px; }

/* Admin Styling */
.admin-item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
.sort-btns { display: flex; gap: 4px; margin-right: 15px; }
.sort-btn { background: #f2f2f7; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }

/* Keypad */
.keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #c7c7cc; border-radius: 24px; overflow: hidden; }
.key { background: white; padding: 22px; text-align: center; font-size: 24px; font-weight: 600; cursor: pointer; }
.key:active { background: #f2f2f7; }
.dot { width: 14px; height: 14px; border-radius: 50%; background: rgba(0,0,0,0.1); margin: 0 6px; transition: background 0.2s; }
.dot.filled { background: #1c1c1e; transform: scale(1.3); }
</style>
</head>
<body>

<div id="mainLockScreen" style="position:fixed; inset:0; z-index:9999; background:rgba(255,255,255,0.2); backdrop-filter:blur(50px); display:flex; flex-direction:column; align-items:center; justify-content:center; transition: 0.5s;">
    <div id="lockUI" style="width:340px; text-align:center;">
        <h2 id="txtLockTitle"></h2>
        <div style="display:flex; justify-content:center; margin:25px 0;" id="userDots"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div class="keypad" id="userKeypad"></div>
    </div>
</div>

<div class="app-container" id="appBody">
  <div class="lang-bar">
    <button class="lang-btn active" id="btn-th" onclick="toggleLang('th')">ไทย</button>
    <button class="lang-btn" id="btn-en" onclick="toggleLang('en')">EN</button>
    <button class="lang-btn" id="btn-mm" onclick="toggleLang('mm')">မြန်မာ</button>
  </div>

  <div class="panel left-panel">
    <div class="tab-group">
        <div id="tabSlider" class="tab-slider"></div>
        <div id="tabUse" class="tab active" onclick="setMode('use')"></div>
        <div id="tabProduce" class="tab" onclick="setMode('produce')"></div>
    </div>
    <div class="item-list" id="itemList"></div>
    <div style="padding:15px; border-top:1px solid rgba(0,0,0,0.05);"><button id="btnAdmin" style="background:rgba(0,0,0,0.06); border:none; padding:15px; border-radius:15px; width:100%; cursor:pointer; font-weight:700;" onclick="openAdminPin()"></button></div>
  </div>

  <div class="panel right-panel">
    <div id="summaryArea" style="flex:1; padding:20px; overflow-y:auto;"></div>
    <div style="padding: 0 25px 15px;"><button id="btnSubmit" style="color:white; border:none; padding:18px; border-radius:18px; font-weight:700; width:100%; cursor:pointer;" onclick="showFinalReview()"></button></div>
    <div style="padding: 20px 30px; background: rgba(255,255,255,0.4); border-top:1px solid rgba(0,0,0,0.05);">
        <div id="displayItem" style="font-size: 20px; font-weight: 800; min-height: 48px; display:flex; align-items:center;"></div>
        <div id="displayQty" style="font-size: 60px; font-weight: 900;">0</div>
    </div>
    <div class="keypad" id="mainKeypad"></div>
  </div>
</div>

<div class="modal-overlay" id="adminModal">
    <div class="modal-box">
        <h3 style="text-align:center; margin-top:0;">จัดการรายการสินค้า</h3>
        <div style="background:#f2f2f7; padding:15px; border-radius:20px; margin-bottom:15px;">
            <input type="hidden" id="editIndex" value="-1">
            <input type="text" id="newTh" placeholder="ชื่อไทย" oninput="handleAlias(this)">
            <input type="text" id="newEn" placeholder="English Name">
            <input type="text" id="newMm" placeholder="မြန်မာအမည်">
            <input type="text" id="newImg" placeholder="Link รูปภาพ">
            <input type="text" id="newEid" placeholder="Google Entry ID">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button id="btnSaveUpdate" style="flex:2; padding:15px; color:white; border:none; border-radius:14px; font-weight:800; cursor:pointer;" onclick="saveItem()">SAVE / บันทึก</button>
                <button id="btnCancelEntry" style="flex:1; padding:15px; background:#8e8e93; color:white; border:none; border-radius:14px; font-weight:800; cursor:pointer;" onclick="clearAdminForm()">CANCEL</button>
            </div>
            <button id="btnCancelEdit" style="display:none; width:100%; padding:10px; background:none; border:none; color:red; cursor:pointer; font-weight:bold;" onclick="clearAdminForm()">ยกเลิกการแก้ไข</button>
        </div>
        <div id="adminList" style="max-height:300px; overflow-y:auto;"></div>
        <button style="width:100%; padding:15px; background:none; border:none; color:#666; font-weight:bold; cursor:pointer;" onclick="closeModal()">ปิดหน้าต่างจัดการ</button>
    </div>
</div>

<div class="modal-overlay" id="adminPinModal">
    <div class="modal-box" style="width:350px; text-align:center;">
        <div id="adminPinUI">
            <h3>ADMIN PIN</h3>
            <div style="display:flex; justify-content:center; margin:20px 0;" id="adminDots"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div class="keypad" id="adminKeypad"></div>
            <button style="width:100%; padding:15px; background:none; border:none; color:red; font-weight:bold; cursor:pointer; margin-top:10px;" onclick="closeModal()">CANCEL / ยกเลิก</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="reviewModal">
    <div class="modal-box">
        <h2 id="txtReviewTitle" style="text-align:center;"></h2>
        <div id="reviewBody" style="max-height: 60vh; overflow-y: auto;"></div>
        <div style="display:flex; flex-direction:column; gap:12px; margin-top:25px;">
            <button id="btnConfirm" style="color:white; border:none; padding:20px; border-radius:20px; font-weight:800;" onclick="submitToGoogle()">SEND / ส่งข้อมูล</button>
            <button id="btnEditBack" style="background:none; border:none; color:red; font-weight:700;" onclick="closeModal()">BACK / กลับ</button>
        </div>
    </div>
</div>

<script>
// Logic & Functions
const ui = {
    th: { lock: "กรุณาใส่รหัสผ่าน", use: "ใช้วัตถุดิบ", produce: "ผลิตเพิ่ม", admin: "✏️ ตั้งค่ารายการ", submit: "ตรวจสอบและส่งข้อมูล", review: "ทวนรายการก่อนส่ง", confirm: "ยืนยันส่งข้อมูล", back: "กลับไปแก้ไข", select: "เลือกรายการ...", del: "ลบ" },
    en: { lock: "Enter PIN", use: "Usage", produce: "Production", admin: "✏️ Settings", submit: "Review & Send", review: "Final Review", confirm: "Confirm", back: "Back", select: "Select Item...", del: "Del" },
    mm: { lock: "စကားဝှက်ထည့်ပါ", use: "ကုန်ကြမ်းသုံး", produce: "ထုတ်လုပ်မှု", admin: "✏️ ပြင်ဆင်ရန်", submit: "စစ်ဆေးပြီးပို့မည်", review: "ပြန်စစ်ဆေးရန်", confirm: "ပို့မည်", back: "ပြင်ဆင်ရန်", select: "ပစ္စည်းရွေးပါ...", del: "ဖျက်" }
};

const customerAliases = { "ญาดา": "โกเหล็ก", "ญาดาการเกษตร": "โกเหล็ก", "ฟาร์มจุล": "ฟาร์มจูล", "จุล": "ฟาร์มจูล", "ควนขนุน": "สหกรณ์ควนขนุน" };

let items = {
    use: [
        { th:'รำโม่', en:'Rice Bran', mm:'ဖွဲနု', eid:'e1', img:'' }, 
        { th:'รำเนียน', en:'Fine Bran', mm:'ဖွဲနု (นุ)', eid:'e2', img:'' },
        { th:'หมูป่น', en:'Pork Meal', mm:'ဝက်သားမှုန့်', eid:'e3', img:'' },
        { th:'กากมัน P-18', en:'Tapioca P-18', mm:'ပီလောပီနံအကြွင်းအကျန်', eid:'e4', img:'' }
    ],
    produce: [
        { th:'รำ 60 kg', en:'Bran 60kg', mm:'ဖွဲနု ၆၀', eid:'p1', img:'' }, 
        { th:'ข้าวโพดบด', en:'Ground Maize', mm:'ပြောင်းဖူးမှုန့်', eid:'p2', img:'' }
    ]
};

let userPin = "", adminPin = "", selectedLangs = ["th"], currentMode = "use", currentQty = "", selectedItem = null, cart = [];

// Service Worker Registration (เพื่อความเป็น PWA)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW fail:', err));
  });
}

function toggleLang(l) {
    const i = selectedLangs.indexOf(l);
    if(i > -1) { if(selectedLangs.length > 1) selectedLangs.splice(i, 1); }
    else { selectedLangs.push(l); if(selectedLangs.length > 2) selectedLangs.shift(); }
    updateUIVisuals();
}

function getDual(key) { return selectedLangs.map(l => ui[l][key]).join(" / "); }
function getItemDual(it) { return selectedLangs.map(l => it[l] || it.th).join(" / "); }

function updateUIVisuals() {
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', selectedLangs.includes(b.id.split('-')[1])));
    document.getElementById('txtLockTitle').textContent = getDual('lock');
    document.getElementById('tabUse').innerHTML = getDual('use').replace(/\s\/\s/g, "<br>");
    document.getElementById('tabProduce').innerHTML = getDual('produce').replace(/\s\/\s/g, "<br>");
    document.getElementById('btnAdmin').textContent = getDual('admin');
    document.getElementById('btnSubmit').textContent = getDual('submit');
    document.getElementById('txtReviewTitle').textContent = getDual('review');
    document.getElementById('displayItem').textContent = selectedItem ? getItemDual(selectedItem) : getDual('select');
    
    const color = currentMode === 'use' ? 'var(--mac-use)' : 'var(--mac-produce)';
    document.getElementById('displayQty').style.color = color;
    document.getElementById('btnSubmit').style.background = color;
    document.getElementById('btnConfirm').style.background = color;
    document.getElementById('btnSaveUpdate').style.background = color;

    renderItems(); renderSummary();
}

function renderItems() {
    const list = document.getElementById('itemList'); list.innerHTML = '';
    items[currentMode].forEach(it => {
        const d = document.createElement('div');
        d.className = 'item-card' + (selectedItem?.eid === it.eid ? ` active-${currentMode}` : '');
        let bg = it.img ? `<img src="${it.img}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(0.5);">` : `<div style="position:absolute; inset:0; background:#636366;"></div>`;
        d.innerHTML = `${bg}<div class="overlay-text" style="font-size:${selectedLangs.length>1?'15px':'19px'}">${selectedLangs.map(l => `<span>${it[l]||it.th}</span>`).join('')}</div>`;
        d.onclick = () => { selectedItem = it; currentQty = ""; renderItems(); document.getElementById('displayItem').textContent = getItemDual(it); };
        list.appendChild(d);
    });
}

function renderSummary() {
    const area = document.getElementById('summaryArea'); area.innerHTML = '';
    cart.forEach((it, idx) => {
        area.innerHTML += `<div style="background:white; padding:10px; border-radius:12px; display:flex; justify-content:space-between; margin-bottom:5px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
            <span><b>${getItemDual(it)}</b> <span style="color:var(--mac-blue); margin-left:8px;">× ${it.qty}</span></span>
            <span style="color:red; cursor:pointer; padding:0 5px;" onclick="cart.splice(${idx},1); renderSummary();">✕</span>
        </div>`;
    });
}

function handleUserPin(v) {
    if(v==='⌫') userPin = userPin.slice(0,-1); else if(v==='C') userPin=""; else if(userPin.length<4) userPin+=v;
    document.querySelectorAll('#userDots .dot').forEach((d,i) => d.classList.toggle('filled', i<userPin.length));
    if(userPin === "1111") {
        document.getElementById('mainLockScreen').style.transform='translateY(-100%)';
        document.getElementById('appBody').classList.add('unlocked');
    } else if(userPin.length === 4) {
        triggerShake('lockUI'); userPin = "";
        setTimeout(() => document.querySelectorAll('#userDots .dot').forEach(d => d.classList.remove('filled')), 400);
    }
}

function handleMainInput(v) {
    if(v==='⌫') currentQty = currentQty.slice(0,-1);
    else if(v==='C') currentQty = "";
    else if(v==='OK') {
        if(selectedItem && currentQty) {
            cart.push({...selectedItem, qty:currentQty, mode:currentMode});
            currentQty=""; selectedItem=null; updateUIVisuals();
        }
    }
    else if(currentQty.length<6) currentQty+=v;
    document.getElementById('displayQty').textContent = currentQty || "0";
}

function buildKeypad(id, cb, isMain=false) {
    const c = document.getElementById(id); c.innerHTML = '';
    const keys = isMain ? ['1','2','3','4','5','6','7','8','9','C','0','OK'] : ['1','2','3','4','5','6','7','8','9','C','0','⌫'];
    keys.forEach(v => {
        const k = document.createElement('div');
        k.className = 'key'; k.textContent = v;
        if(v==='OK') { k.style.background='var(--mac-blue)'; k.style.color='white'; }
        k.onclick = () => cb(v);
        c.appendChild(k);
    });
}

function triggerShake(id) {
    const el = document.getElementById(id);
    el.classList.remove('error-shake'); void el.offsetWidth; el.classList.add('error-shake');
}

function setMode(m) {
    currentMode = m;
    document.getElementById('tabSlider').style.transform = m==='use'?'translateX(0)':'translateX(100%)';
    updateUIVisuals();
}

function showFinalReview() {
    if(!cart.length) return;
    const b = document.getElementById('reviewBody'); b.innerHTML = '';
    cart.forEach(it => {
        b.innerHTML += `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee;">
            <span>${getItemDual(it)}</span><b>${it.qty}</b>
        </div>`;
    });
    document.getElementById('reviewModal').style.display='flex';
}

function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
function openAdminPin() { adminPin = ""; document.getElementById('adminPinModal').style.display='flex'; }
function handleAlias(i) { if(customerAliases[i.value]) i.value = customerAliases[i.value]; }

// ขั้นตอนสุดท้าย: เปิดแอป
buildKeypad('userKeypad', handleUserPin);
buildKeypad('adminKeypad', (v) => {
    if(v==='⌫') adminPin = adminPin.slice(0,-1); else if(adminPin.length<4) adminPin+=v;
    if(adminPin === "1234") { closeModal(); document.getElementById('adminModal').style.display='flex'; }
});
buildKeypad('mainKeypad', handleMainInput, true);
updateUIVisuals();

function submitToGoogle() {
    alert("ส่งข้อมูลสำเร็จ! (จำลอง)");
    cart = [];
    closeModal();
    renderSummary();
}
</script>
</body>
</html>
